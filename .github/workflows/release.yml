name: è‡ªåŠ¨åŒ–å‘å¸ƒ

on:
  workflow_dispatch:
    inputs:
      version_type:
        description: 'ç‰ˆæœ¬ç±»å‹'
        required: true
        default: 'patch'
        type: choice
        options:
          - patch
          - minor
          - major
      packages:
        description: 'è¦å‘å¸ƒçš„åŒ… (ç”¨é€—å·åˆ†éš”ï¼Œç•™ç©ºå‘å¸ƒå…¨éƒ¨)'
        required: false
        default: ''
        type: string

env:
  NODE_VERSION: '18'
  BUN_VERSION: '1.0.0'

jobs:
  # ç‰ˆæœ¬æ›´æ–°å’Œå‘å¸ƒ
  release:
    name: å‘å¸ƒæ–°ç‰ˆæœ¬
    runs-on: ubuntu-latest

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: é…ç½® Git
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      - name: å®‰è£… Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: ${{ env.BUN_VERSION }}

      - name: è·å–ä¾èµ–ç¼“å­˜
        uses: actions/cache@v3
        with:
          path: ~/.bun/install/cache
          key: ${{ runner.os }}-bun-${{ hashFiles('**/bun.lockb') }}
          restore-keys: |
            ${{ runner.os }}-bun-

      - name: å®‰è£…ä¾èµ–
        run: bun install

      - name: è¿è¡Œæµ‹è¯•
        run: bun run test

      - name: æ„å»ºé¡¹ç›®
        run: bun run build

      - name: ç¡®å®šè¦å‘å¸ƒçš„åŒ…
        id: packages
        run: |
          if [[ -n "${{ github.event.inputs.packages }}" ]]; then
            PACKAGES="${{ github.event.inputs.packages }}"
            echo "å‘å¸ƒæŒ‡å®šåŒ…: $PACKAGES"
          else
            PACKAGES="core,react,vue"
            echo "å‘å¸ƒæ‰€æœ‰åŒ…: $PACKAGES"
          fi
          echo "packages=$PACKAGES" >> $GITHUB_OUTPUT

      - name: æ›´æ–°ç‰ˆæœ¬å·
        id: version
        run: |
          VERSION_TYPE="${{ github.event.inputs.version_type }}"
          PACKAGES="${{ steps.packages.outputs.packages }}"

          echo "ç‰ˆæœ¬ç±»å‹: $VERSION_TYPE"
          echo "å‘å¸ƒåŒ…: $PACKAGES"

          # è·å–å½“å‰ç‰ˆæœ¬
          CURRENT_VERSION=$(cat package.json | jq -r .version)
          echo "å½“å‰ç‰ˆæœ¬: $CURRENT_VERSION"

          # è®¡ç®—æ–°ç‰ˆæœ¬å·
          IFS='.' read -ra VERSION_PARTS <<< "$CURRENT_VERSION"
          MAJOR=${VERSION_PARTS[0]}
          MINOR=${VERSION_PARTS[1]}
          PATCH=${VERSION_PARTS[2]}

          case $VERSION_TYPE in
            "patch")
              NEW_PATCH=$((PATCH + 1))
              NEW_VERSION="$MAJOR.$MINOR.$NEW_PATCH"
              ;;
            "minor")
              NEW_MINOR=$((MINOR + 1))
              NEW_VERSION="$MAJOR.$NEW_MINOR.0"
              ;;
            "major")
              NEW_MAJOR=$((MAJOR + 1))
              NEW_VERSION="$NEW_MAJOR.0.0"
              ;;
          esac

          echo "æ–°ç‰ˆæœ¬å·: $NEW_VERSION"
          echo "new_version=$NEW_VERSION" >> $GITHUB_OUTPUT

          # æ›´æ–°æ ¹ç›®å½•ç‰ˆæœ¬
          jq --arg new_version "$NEW_VERSION" '.version = $new_version' package.json > package.json.tmp
          mv package.json.tmp package.json

          # æ›´æ–°å„ä¸ªåŒ…çš„ç‰ˆæœ¬
          for package in $(echo $PACKAGES | tr ',' ' '); do
            echo "æ›´æ–° $package åŒ…ç‰ˆæœ¬åˆ° $NEW_VERSION"
            jq --arg new_version "$NEW_VERSION" '.version = $new_version' packages/$package/package.json > packages/$package/package.json.tmp
            mv packages/$package/package.json.tmp packages/$package/package.json
          done

      - name: æ›´æ–° CHANGELOG
        run: |
          NEW_VERSION="${{ steps.version.outputs.new_version }}"
          VERSION_TYPE="${{ github.event.inputs.version_type }}"
          PACKAGES="${{ steps.packages.outputs.packages }}"

          # åˆ›å»ºå˜æ›´æ—¥å¿—æ¡ç›®
          cat > CHANGELOG_ENTRY.tmp << 'EOF'
## [NEW_VERSION_PLACEHOLDER] - DATE_PLACEHOLDER

### ğŸš€ æ–°ç‰ˆæœ¬å‘å¸ƒ
- ç‰ˆæœ¬ç±»å‹: VERSION_TYPE_PLACEHOLDER
- å‘å¸ƒåŒ…: PACKAGES_PLACEHOLDER
- è‡ªåŠ¨åŒ–æ„å»ºå’Œå‘å¸ƒ

### ğŸ“¦ åŒ…æ›´æ–°

EOF

          # ä¸ºæ¯ä¸ªåŒ…æ·»åŠ æ›´æ–°ä¿¡æ¯
          for package in $(echo $PACKAGES | tr ',' ' '); do
            PACKAGE_NAME="@btc-connect/$package"
            echo "- **$PACKAGE_NAME**: ç‰ˆæœ¬æ›´æ–°è‡³ $NEW_VERSION" >> CHANGELOG_ENTRY.tmp
          done

          echo "" >> CHANGELOG_ENTRY.tmp
          echo "### ğŸ”— é“¾æ¥" >> CHANGELOG_ENTRY.tmp
          echo "- [å®‰è£…æŒ‡å—](https://github.com/${{ github.repository }}/blob/main/README.md)" >> CHANGELOG_ENTRY.tmp
          echo "- [æ–‡æ¡£](https://github.com/${{ github.repository }}/tree/main/packages)" >> CHANGELOG_ENTRY.tmp
          echo "- [å˜æ›´æ—¥å¿—](https://github.com/${{ github.repository }}/releases)" >> CHANGELOG_ENTRY.tmp
          echo "" >> CHANGELOG_ENTRY.tmp

          # æ›¿æ¢å ä½ç¬¦
          sed -i.bak "s/NEW_VERSION_PLACEHOLDER/$NEW_VERSION/g" CHANGELOG_ENTRY.tmp
          sed -i.bak "s/DATE_PLACEHOLDER/$(date +%Y-%m-%d)/g" CHANGELOG_ENTRY.tmp
          sed -i.bak "s/VERSION_TYPE_PLACEHOLDER/$VERSION_TYPE/g" CHANGELOG_ENTRY.tmp
          sed -i.bak "s/PACKAGES_PLACEHOLDER/$PACKAGES/g" CHANGELOG_ENTRY.tmp

          # å¦‚æœ CHANGELOG.md ä¸å­˜åœ¨ï¼Œåˆ›å»ºå®ƒ
          if [ ! -f CHANGELOG.md ]; then
            echo "# å˜æ›´æ—¥å¿—" > CHANGELOG.md
            echo "" >> CHANGELOG.md
          fi

          # åœ¨æ–‡ä»¶å¼€å¤´æ’å…¥æ–°æ¡ç›®
          sed -i "3r CHANGELOG_ENTRY.tmp" CHANGELOG.md

          # æ¸…ç†ä¸´æ—¶æ–‡ä»¶
          rm -f CHANGELOG_ENTRY.tmp CHANGELOG_ENTRY.tmp.bak

      - name: æäº¤ç‰ˆæœ¬æ›´æ–°
        run: |
          NEW_VERSION="${{ steps.version.outputs.new_version }}"

          git add .
          git commit -m "chore(release): å‘å¸ƒç‰ˆæœ¬ $NEW_VERSION

ğŸ¤– è‡ªåŠ¨åŒ–å‘å¸ƒ
- ç‰ˆæœ¬ç±»å‹: ${{ github.event.inputs.version_type }}
- å‘å¸ƒåŒ…: ${{ steps.packages.outputs.packages }}
- æ›´æ–°æ‰€æœ‰ç›¸å…³åŒ…ç‰ˆæœ¬å’Œæ–‡æ¡£"

      - name: åˆ›å»ºå¹¶æ¨é€æ ‡ç­¾
        run: |
          NEW_VERSION="${{ steps.version.outputs.new_version }}"

          git tag -a "v$NEW_VERSION" -m "Release v$NEW_VERSION

ğŸš€ btc-connect ç‰ˆæœ¬ $NEW_VERSION

åŒ…å«ä»¥ä¸‹åŒ…æ›´æ–°:
${{ steps.packages.outputs.packages }}

ğŸ“… å‘å¸ƒæ—¶é—´: $(date +%Y-%m-%d)"

          git push origin main
          git push origin "v$NEW_VERSION"

      - name: åˆ›å»º GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ steps.version.outputs.new_version }}
          name: ğŸš€ Release v${{ steps.version.outputs.new_version }}
          draft: false
          prerelease: false
          body: |
            # ğŸš€ btc-connect v${{ steps.version.outputs.new_version }}

            ğŸ‰ **æ–°ç‰ˆæœ¬å‘å¸ƒï¼** è¿™æ˜¯ btc-connect çš„ç‰ˆæœ¬ ${{ steps.version.outputs.new_version }}ï¼ŒåŒ…å«é‡è¦çš„åŠŸèƒ½æ›´æ–°å’Œæ”¹è¿›ã€‚

            ## ğŸ“¦ åŒ…æ›´æ–°
            ${{ steps.packages.outputs.packages }} åŒ…å·²æ›´æ–°è‡³æ–°ç‰ˆæœ¬ã€‚

            ## ğŸ”„ ç‰ˆæœ¬ç±»å‹
            - **ç±»å‹**: ${{ github.event.inputs.version_type }}
            - **å‘å¸ƒæ—¥æœŸ**: $(date +%Y-%m-%d)

            ## ğŸš€ å¿«é€Ÿå¼€å§‹

            ```bash
            # å®‰è£…æ ¸å¿ƒåŒ…
            npm install @btc-connect/core@${{ steps.version.outputs.new_version }}

            # å®‰è£… React é›†æˆ
            npm install @btc-connect/react@${{ steps.version.outputs.new_version }}

            # å®‰è£… Vue é›†æˆ
            npm install @btc-connect/vue@${{ steps.version.outputs.new_version }}
            ```

            ## ğŸ“š æ–‡æ¡£

            - ğŸ“– [å®Œæ•´æ–‡æ¡£](https://github.com/${{ github.repository }})
            - ğŸ”§ [API å‚è€ƒ](https://github.com/${{ github.repository }}/tree/main/packages)
            - ğŸ“‹ [å˜æ›´æ—¥å¿—](https://github.com/${{ github.repository }}/blob/main/CHANGELOG.md)

            ## ğŸ¤ è´¡çŒ®

            æ¬¢è¿è´¡çŒ®ä»£ç ï¼è¯·æŸ¥çœ‹ [è´¡çŒ®æŒ‡å—](https://github.com/${{ github.repository }}/blob/main/CONTRIBUTING.md)ã€‚

            ---

            â­ å¦‚æœè¿™ä¸ªé¡¹ç›®å¯¹ä½ æœ‰å¸®åŠ©ï¼Œè¯·ç»™æˆ‘ä»¬ä¸€ä¸ª Starï¼
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: å‘å¸ƒåˆ° NPM
        env:
          NPM_TOKEN: ${{ secrets.NPM_TOKEN }}
        run: |
          NEW_VERSION="${{ steps.version.outputs.new_version }}"
          PACKAGES="${{ steps.packages.outputs.packages }}"

          echo "//registry.npmjs.org/:_authToken=$NPM_TOKEN" > ~/.npmrc

          for package in $(echo $PACKAGES | tr ',' ' '); do
            echo "æ­£åœ¨å‘å¸ƒ @btc-connect/$package@$NEW_VERSION..."
            cd packages/$package

            # æ£€æŸ¥åŒ…æ˜¯å¦å·²å­˜åœ¨
            PACKAGE_NAME="@btc-connect/$package"
            HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" "https://registry.npmjs.org/$PACKAGE_NAME/$NEW_VERSION")

            if [ "$HTTP_STATUS" = "200" ]; then
              echo "âš ï¸ $PACKAGE_NAME@$NEW_VERSION å·²å­˜åœ¨äº NPMï¼Œè·³è¿‡å‘å¸ƒ"
            else
              echo "ğŸ“¦ å‘å¸ƒ $PACKAGE_NAME@$NEW_VERSION..."
              bun publish --access public
              echo "âœ… $PACKAGE_NAME@$NEW_VERSION å‘å¸ƒæˆåŠŸ"
            fi

            cd ../..
          done

      - name: é€šçŸ¥å‘å¸ƒå®Œæˆ
        run: |
          NEW_VERSION="${{ steps.version.outputs.new_version }}"
          PACKAGES="${{ steps.packages.outputs.packages }}"

          echo "ğŸ‰ å‘å¸ƒå®Œæˆï¼"
          echo "ğŸ“¦ ç‰ˆæœ¬: v$NEW_VERSION"
          echo "ğŸ“¦ åŒ…: $PACKAGES"
          echo "ğŸ”— NPM: https://www.npmjs.com/package/@btc-connect"
          echo "ğŸ”— GitHub: https://github.com/${{ github.repository }}/releases/tag/v$NEW_VERSION"